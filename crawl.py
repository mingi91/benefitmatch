import requests
import json
import re
from tqdm import tqdm
import gzip

API_KEY = "ZuK00g5OQwrnp8WTkgktU3rkw62gi5qKb0AkBmz8A16xGhov1WqDbbvOaIx10Sa3kBUqdS9hAEJJ8IS3sTpbgA=="
BASE_URL = "https://api.odcloud.kr/api/gov24/v3"

# ---------------- fetch_all_data ----------------
def fetch_all_data(endpoint):
    all_data = []
    page = 1
    per_page = 1000
    while True:
        url = f"{BASE_URL}/{endpoint}?page={page}&perPage={per_page}&serviceKey={API_KEY}"
        response = requests.get(url)
        if response.status_code != 200:
            print(f"âŒ {endpoint} ì˜¤ë¥˜: {response.status_code}")
            break
        data = response.json()
        if "data" not in data or not data["data"]:
            break
        all_data.extend(data["data"])
        if len(data["data"]) < per_page:
            break
        page += 1
    return all_data

# ---------------- REGION_KEYWORDS ----------------
REGION_KEYWORDS = {
    # ê´‘ì—­ì‹œÂ·ë„
    "ì„œìš¸": "ì„œìš¸", "ë¶€ì‚°": "ë¶€ì‚°", "ëŒ€êµ¬": "ëŒ€êµ¬", "ì¸ì²œ": "ì¸ì²œ",
    "ê´‘ì£¼": "ê´‘ì£¼", "ëŒ€ì „": "ëŒ€ì „", "ìš¸ì‚°": "ìš¸ì‚°", "ì„¸ì¢…": "ì„¸ì¢…",
    "ê²½ê¸°": "ê²½ê¸°", "ê°•ì›": "ê°•ì›", "ì¶©ë¶": "ì¶©ë¶", "ì¶©ì²­ë¶ë„": "ì¶©ë¶",
    "ì¶©ë‚¨": "ì¶©ë‚¨", "ì¶©ì²­ë‚¨ë„": "ì¶©ë‚¨", "ì „ë¶": "ì „ë¶", "ì „ë¼ë¶ë„": "ì „ë¶",
    "ì „ë‚¨": "ì „ë‚¨", "ì „ë¼ë‚¨ë„": "ì „ë‚¨", "ê²½ë¶": "ê²½ë¶", "ê²½ìƒë¶ë„": "ê²½ë¶",
    "ê²½ë‚¨": "ê²½ë‚¨", "ê²½ìƒë‚¨ë„": "ê²½ë‚¨", "ì œì£¼": "ì œì£¼",

    # ê²½ê¸°ë„
    "ìˆ˜ì›ì‹œ": "ê²½ê¸°","ì„±ë‚¨ì‹œ": "ê²½ê¸°","ê³ ì–‘ì‹œ": "ê²½ê¸°","ìš©ì¸ì‹œ": "ê²½ê¸°","ë¶€ì²œì‹œ": "ê²½ê¸°","ì•ˆì‚°ì‹œ": "ê²½ê¸°",
    "ì•ˆì–‘ì‹œ": "ê²½ê¸°","ë‚¨ì–‘ì£¼ì‹œ": "ê²½ê¸°","í™”ì„±ì‹œ": "ê²½ê¸°","í‰íƒì‹œ": "ê²½ê¸°","ì˜ì •ë¶€ì‹œ": "ê²½ê¸°","ì‹œí¥ì‹œ": "ê²½ê¸°",
    "íŒŒì£¼ì‹œ": "ê²½ê¸°","ê¹€í¬ì‹œ": "ê²½ê¸°","ê´‘ëª…ì‹œ": "ê²½ê¸°","ê´‘ì£¼ì‹œ": "ê²½ê¸°","êµ°í¬ì‹œ": "ê²½ê¸°","ì´ì²œì‹œ": "ê²½ê¸°",
    "ì˜¤ì‚°ì‹œ": "ê²½ê¸°","ì–‘ì£¼ì‹œ": "ê²½ê¸°","êµ¬ë¦¬ì‹œ": "ê²½ê¸°","ì•ˆì„±ì‹œ": "ê²½ê¸°","í¬ì²œì‹œ": "ê²½ê¸°","ì˜ì™•ì‹œ": "ê²½ê¸°",
    "í•˜ë‚¨ì‹œ": "ê²½ê¸°","ì—¬ì£¼ì‹œ": "ê²½ê¸°","ì–‘í‰êµ°": "ê²½ê¸°","ê°€í‰êµ°": "ê²½ê¸°","ì—°ì²œêµ°": "ê²½ê¸°",

    # ê°•ì›ë„
    "ì¶˜ì²œì‹œ": "ê°•ì›","ì›ì£¼ì‹œ": "ê°•ì›","ê°•ë¦‰ì‹œ": "ê°•ì›","ë™í•´ì‹œ": "ê°•ì›","íƒœë°±ì‹œ": "ê°•ì›","ì†ì´ˆì‹œ": "ê°•ì›",
    "ì‚¼ì²™ì‹œ": "ê°•ì›","í™ì²œêµ°": "ê°•ì›","íš¡ì„±êµ°": "ê°•ì›","ì˜ì›”êµ°": "ê°•ì›","í‰ì°½êµ°": "ê°•ì›","ì •ì„ êµ°": "ê°•ì›",
    "ì² ì›êµ°": "ê°•ì›","í™”ì²œêµ°": "ê°•ì›","ì–‘êµ¬êµ°": "ê°•ì›","ì¸ì œêµ°": "ê°•ì›","ê³ ì„±êµ°": "ê°•ì›","ì–‘ì–‘êµ°": "ê°•ì›",

    # ì¶©ì²­ë¶ë„
    "ì²­ì£¼ì‹œ": "ì¶©ë¶","ì¶©ì£¼ì‹œ": "ì¶©ë¶","ì œì²œì‹œ": "ì¶©ë¶","ë³´ì€êµ°": "ì¶©ë¶","ì˜¥ì²œêµ°": "ì¶©ë¶","ì˜ë™êµ°": "ì¶©ë¶",
    "ì§„ì²œêµ°": "ì¶©ë¶","ê´´ì‚°êµ°": "ì¶©ë¶","ìŒì„±êµ°": "ì¶©ë¶","ë‹¨ì–‘êµ°": "ì¶©ë¶",

    # ì¶©ì²­ë‚¨ë„
    "ì²œì•ˆì‹œ": "ì¶©ë‚¨","ê³µì£¼ì‹œ": "ì¶©ë‚¨","ë³´ë ¹ì‹œ": "ì¶©ë‚¨","ì•„ì‚°ì‹œ": "ì¶©ë‚¨","ì„œì‚°ì‹œ": "ì¶©ë‚¨","ë…¼ì‚°ì‹œ": "ì¶©ë‚¨",
    "ê³„ë£¡ì‹œ": "ì¶©ë‚¨","ë‹¹ì§„ì‹œ": "ì¶©ë‚¨","ê¸ˆì‚°êµ°": "ì¶©ë‚¨","ë¶€ì—¬êµ°": "ì¶©ë‚¨","ì„œì²œêµ°": "ì¶©ë‚¨","ì²­ì–‘êµ°": "ì¶©ë‚¨",
    "í™ì„±êµ°": "ì¶©ë‚¨","ì˜ˆì‚°êµ°": "ì¶©ë‚¨","íƒœì•ˆêµ°": "ì¶©ë‚¨",

    # ì „ë¼ë¶ë„
    "ì „ì£¼ì‹œ": "ì „ë¶","ì „ì£¼": "ì „ë¶","êµ°ì‚°ì‹œ": "ì „ë¶","ìµì‚°ì‹œ": "ì „ë¶","ì •ìì‹œ": "ì „ë¶","ë‚¨ì›ì‹œ": "ì „ë¶","ê¹€ì œì‹œ": "ì „ë¶",
    "ì™„ì£¼êµ°": "ì „ë¶","ì§„ì•ˆêµ°": "ì „ë¶","ë¬´ì£¼êµ°": "ì „ë¶","ì¥ìˆ˜êµ°": "ì „ë¶","ì„ì‹¤êµ°": "ì „ë¶","ìˆœì°½êµ°": "ì „ë¶",
    "ê³ ì°½êµ°": "ì „ë¶","ë¶€ì•ˆêµ°": "ì „ë¶",

    # ì „ë¼ë‚¨ë„
    "ëª©í¬ì‹œ": "ì „ë‚¨","ì—¬ìˆ˜ì‹œ": "ì „ë‚¨","ìˆœì²œì‹œ": "ì „ë‚¨","ë‚˜ì£¼ì‹œ": "ì „ë‚¨","ê´‘ì–‘ì‹œ": "ì „ë‚¨","ë‹´ì–‘êµ°": "ì „ë‚¨",
    "ê³¡ì„±êµ°": "ì „ë‚¨","êµ¬ë¡€êµ°": "ì „ë‚¨","ê³ í¥êµ°": "ì „ë‚¨","ë³´ì„±êµ°": "ì „ë‚¨","í™”ìˆœêµ°": "ì „ë‚¨","ì¥í¥êµ°": "ì „ë‚¨",
    "ê°•ì§„êµ°": "ì „ë‚¨","í•´ë‚¨êµ°": "ì „ë‚¨","ì˜ì•”êµ°": "ì „ë‚¨","ë¬´ì•ˆêµ°": "ì „ë‚¨","í•¨í‰êµ°": "ì „ë‚¨","ì˜ê´‘êµ°": "ì „ë‚¨",
    "ì¥ì„±êµ°": "ì „ë‚¨","ì™„ë„êµ°": "ì „ë‚¨","ì§„ë„êµ°": "ì „ë‚¨","ì‹ ì•ˆêµ°": "ì „ë‚¨",

    # ê²½ìƒë¶ë„
    "í¬í•­ì‹œ": "ê²½ë¶","ê²½ì£¼ì‹œ": "ê²½ë¶","ê¹€ì²œì‹œ": "ê²½ë¶","ì•ˆë™ì‹œ": "ê²½ë¶","êµ¬ë¯¸ì‹œ": "ê²½ë¶","ì˜ì£¼ì‹œ": "ê²½ë¶",
    "ì˜ì²œì‹œ": "ê²½ë¶","ìƒì£¼ì‹œ": "ê²½ë¶","ë¬¸ê²½ì‹œ": "ê²½ë¶","ê²½ì‚°ì‹œ": "ê²½ë¶","êµ°ìœ„êµ°": "ê²½ë¶","ì˜ì„±êµ°": "ê²½ë¶",
    "ì²­ì†¡êµ°": "ê²½ë¶","ì˜ì–‘êµ°": "ê²½ë¶","ì˜ë•êµ°": "ê²½ë¶","ì²­ë„êµ°": "ê²½ë¶","ê³ ë ¹êµ°": "ê²½ë¶","ì„±ì£¼êµ°": "ê²½ë¶",
    "ì¹ ê³¡êµ°": "ê²½ë¶","ì˜ˆì²œêµ°": "ê²½ë¶","ë´‰í™”êµ°": "ê²½ë¶","ìš¸ì§„êµ°": "ê²½ë¶","ìš¸ë¦‰êµ°": "ê²½ë¶",

    # ê²½ìƒë‚¨ë„
    "ì°½ì›ì‹œ": "ê²½ë‚¨","ì§„ì£¼ì‹œ": "ê²½ë‚¨","í†µì˜ì‹œ": "ê²½ë‚¨","ì‚¬ì²œì‹œ": "ê²½ë‚¨","ê¹€í•´ì‹œ": "ê²½ë‚¨","ë°€ì–‘ì‹œ": "ê²½ë‚¨",
    "ê±°ì œì‹œ": "ê²½ë‚¨","ì–‘ì‚°ì‹œ": "ê²½ë‚¨","ì˜ë ¹êµ°": "ê²½ë‚¨","í•¨ì•ˆêµ°": "ê²½ë‚¨","ì°½ë…•êµ°": "ê²½ë‚¨","ê³ ì„±êµ°": "ê²½ë‚¨",
    "ë‚¨í•´êµ°": "ê²½ë‚¨","í•˜ë™êµ°": "ê²½ë‚¨","ì‚°ì²­êµ°": "ê²½ë‚¨","í•¨ì–‘êµ°": "ê²½ë‚¨","ê±°ì°½êµ°": "ê²½ë‚¨","í•©ì²œêµ°": "ê²½ë‚¨",

    # ì œì£¼
    "ì œì£¼ì‹œ": "ì œì£¼","ì„œê·€í¬ì‹œ": "ì œì£¼",

    # ê´‘ì—­ì‹œ í•˜ìœ„ êµ¬Â·êµ°
    "ë‹¬ì„±êµ°": "ëŒ€êµ¬", "ë‹¬ì„±": "ëŒ€êµ¬","ë‹¬ì„œêµ¬": "ëŒ€êµ¬", "ë‹¬ì„œ": "ëŒ€êµ¬","ìˆ˜ì„±êµ¬": "ëŒ€êµ¬", "ìˆ˜ì„±": "ëŒ€êµ¬",
    "í•´ìš´ëŒ€êµ¬": "ë¶€ì‚°", "í•´ìš´ëŒ€": "ë¶€ì‚°",

    # ëª¨í˜¸ â†’ ì „êµ­ ì²˜ë¦¬ í•„ìš”
    "ì¤‘êµ¬": "ì „êµ­","ë‚¨êµ¬": "ì „êµ­","ë™êµ¬": "ì „êµ­","ì„œêµ¬": "ì „êµ­","ë¶êµ¬": "ì „êµ­"
}

AMBIGUOUS_NAMES = {"ì¤‘êµ¬", "ë‚¨êµ¬", "ë™êµ¬", "ì„œêµ¬", "ë¶êµ¬"}

# ---------------- extract_region ----------------
def extract_region(agency_name: str):
    if not agency_name:
        return "ì „êµ­", "ì „êµ­"

    # 1) ì‹œ/ë„ëª… ì§ì ‘ í¬í•¨
    for keyword, sido in REGION_KEYWORDS.items():
        if keyword in agency_name:
            return sido, keyword if keyword not in AMBIGUOUS_NAMES else "ì „êµ­"

    # 2) â—‹â—‹ì‹œ/êµ°/êµ¬ ì¶”ì¶œ
    match = re.search(r"([ê°€-í£]{2,}(ì‹œ|êµ°|êµ¬))", agency_name)
    if match:
        sigungu = match.group(1)
        if sigungu in AMBIGUOUS_NAMES:
            return "ì „êµ­", sigungu
        return REGION_KEYWORDS.get(sigungu, "ì „êµ­"), sigungu

    # 3) ê¸°ê´€ëª… ì „ì²´ì—ì„œ ë‘ ê¸€ì ì´ìƒ í‚¤ì›Œë“œ íƒìƒ‰
    for keyword, sido in REGION_KEYWORDS.items():
        if len(keyword) >= 2 and keyword in agency_name:
            if keyword in AMBIGUOUS_NAMES:
                return "ì „êµ­", "ì „êµ­"
            return sido, keyword

    # 4) ê¸°ë³¸ê°’
    return "ì „êµ­", "ì „êµ­"

# ---------------- merge_and_save ----------------
def merge_and_save():
    print("âœ… ì„œë¹„ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
    service_list = fetch_all_data("serviceList")
    print(f"ğŸ‘‰ ì´ {len(service_list)}ê±´ ë¶ˆëŸ¬ì˜´")

    print("âœ… ìƒì„¸ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
    detail_list = fetch_all_data("serviceDetail")

    print("âœ… ì¡°ê±´ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
    condition_list = fetch_all_data("supportConditions")

    print("âœ… ë³‘í•© ì¤‘...")
    detail_map = {d["ì„œë¹„ìŠ¤ID"]: d for d in detail_list if "ì„œë¹„ìŠ¤ID" in d}
    condition_map = {c["ì„œë¹„ìŠ¤ID"]: c for c in condition_list if "ì„œë¹„ìŠ¤ID" in c}

    merged = []
    for s in tqdm(service_list):
        sid = s.get("ì„œë¹„ìŠ¤ID", "")
        detail = detail_map.get(sid, {})
        condition = condition_map.get(sid, {})

        region_sido, region_sigungu = extract_region(s.get("ì†Œê´€ê¸°ê´€ëª…", ""))

        record = {
            "id": sid,
            "name": s.get("ì„œë¹„ìŠ¤ëª…", ""),
            "purpose": s.get("ì„œë¹„ìŠ¤ëª©ì ìš”ì•½", ""),
            "target": s.get("ì§€ì›ëŒ€ìƒ", ""),
            "criteria": s.get("ì„ ì •ê¸°ì¤€", ""),
            "details": s.get("ì§€ì›ë‚´ìš©", ""),
            "applyMethod": s.get("ì‹ ì²­ë°©ë²•", ""),
            "deadline": s.get("ì‹ ì²­ê¸°í•œ", ""),
            "viewCount": s.get("ì¡°íšŒìˆ˜", 0),
            "agency": s.get("ì†Œê´€ê¸°ê´€ëª…", ""),
            "department": s.get("ë¶€ì„œëª…", ""),
            "userType": s.get("ì‚¬ìš©ìêµ¬ë¶„", ""),
            "serviceField": s.get("ì„œë¹„ìŠ¤ë¶„ì•¼", ""),
            "applyUrl": s.get("ìƒì„¸ì¡°íšŒURL", ""),
            "phone": s.get("ì „í™”ë¬¸ì˜", ""),
            "registerDate": s.get("ë“±ë¡ì¼ì‹œ", ""),
            "updateDate": s.get("ìˆ˜ì •ì¼ì‹œ", ""),
            "fullPurpose": detail.get("ì„œë¹„ìŠ¤ëª©ì ", ""),
            "requiredDocs": detail.get("êµ¬ë¹„ì„œë¥˜", ""),
            "receptionOrg": detail.get("ì ‘ìˆ˜ê¸°ê´€ëª…", ""),
            "onlineUrl": detail.get("ì˜¨ë¼ì¸ì‹ ì²­ì‚¬ì´íŠ¸URL", ""),
            "law": detail.get("ë²•ë ¹", ""),
            "condition": condition,
            "regionSido": region_sido,
            "regionSigungu": region_sigungu
        }
        merged.append(record)

    output_path = "C:/Users/admin/Documents/GitHub/benefitmatch/benefits.json.gz"
    with gzip.open(output_path, "wt", encoding="utf-8") as f:
        json.dump(merged, f, ensure_ascii=False)

    print(f"ğŸ‰ ì´ {len(merged)}ê±´ ì €ì¥ ì™„ë£Œ â†’ {output_path} (gzip ì••ì¶•)")

# ---------------- main ----------------
if __name__ == "__main__":
    merge_and_save()
