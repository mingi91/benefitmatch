import requests
import json
import re
import gzip
from tqdm import tqdm
from datetime import datetime
import google.auth
from google.oauth2 import service_account
import google.auth.transport.requests
import os

# ---------------- ê¸°ë³¸ ì„¤ì • ----------------
API_KEY = "ZuK00g5OQwrnp8WTkgktU3rkw62gi5qKb0AkBmz8A16xGhov1WqDbbvOaIx10Sa3kBUqdS9hAEJJ8IS3sTpbgA=="
BASE_URL = "https://api.odcloud.kr/api/gov24/v3"
OUTPUT_PATH = "C:/Users/admin/Documents/GitHub/benefitmatch/benefits.json.gz"
SERVICE_ACCOUNT_FILE = "firebase_service_key.json"  # Firebase ì„œë¹„ìŠ¤ ê³„ì • í‚¤ ê²½ë¡œ
PROJECT_ID = "benefitmatch-bc1ab"  # â˜…Firebase ì½˜ì†”ì—ì„œ í”„ë¡œì íŠ¸ ID ì…ë ¥

# ---------------- fetch_all_data ----------------
def fetch_all_data(endpoint):
    all_data = []
    page = 1
    per_page = 500
    while True:
        url = f"{BASE_URL}/{endpoint}?page={page}&perPage={per_page}&serviceKey={API_KEY}"
        response = requests.get(url)
        if response.status_code != 200:
            print(f"âŒ {endpoint} ì˜¤ë¥˜: {response.status_code}, page={page}")
            print("ì‘ë‹µ ë‚´ìš©:", response.text)  # â† ì¶”ê°€ (ì—ëŸ¬ ë‚´ìš© í™•ì¸)
            break
        data = response.json()
        if "data" not in data or not data["data"]:
            break
        all_data.extend(data["data"])
        if len(data["data"]) < per_page:
            break
        page += 1
    return all_data

# ---------------- REGION_KEYWORDS ----------------
REGION_KEYWORDS = {
    # ê´‘ì—­ì‹œÂ·ë„
    "ì„œìš¸": "ì„œìš¸", "ë¶€ì‚°": "ë¶€ì‚°", "ëŒ€êµ¬": "ëŒ€êµ¬", "ì¸ì²œ": "ì¸ì²œ",
    "ê´‘ì£¼": "ê´‘ì£¼", "ëŒ€ì „": "ëŒ€ì „", "ìš¸ì‚°": "ìš¸ì‚°", "ì„¸ì¢…": "ì„¸ì¢…",
    "ê²½ê¸°": "ê²½ê¸°", "ê°•ì›": "ê°•ì›", "ì¶©ë¶": "ì¶©ë¶", "ì¶©ì²­ë¶ë„": "ì¶©ë¶",
    "ì¶©ë‚¨": "ì¶©ë‚¨", "ì¶©ì²­ë‚¨ë„": "ì¶©ë‚¨", "ì „ë¶": "ì „ë¶", "ì „ë¼ë¶ë„": "ì „ë¶",
    "ì „ë‚¨": "ì „ë‚¨", "ì „ë¼ë‚¨ë„": "ì „ë‚¨", "ê²½ë¶": "ê²½ë¶", "ê²½ìƒë¶ë„": "ê²½ë¶",
    "ê²½ë‚¨": "ê²½ë‚¨", "ê²½ìƒë‚¨ë„": "ê²½ë‚¨", "ì œì£¼": "ì œì£¼",

    # ê²½ê¸°ë„
    "ìˆ˜ì›ì‹œ": "ê²½ê¸°","ìˆ˜ì›": "ê²½ê¸°","ì„±ë‚¨ì‹œ": "ê²½ê¸°","ì„±ë‚¨": "ê²½ê¸°","ê³ ì–‘ì‹œ": "ê²½ê¸°","ê³ ì–‘": "ê²½ê¸°","ìš©ì¸ì‹œ": "ê²½ê¸°","ìš©ì¸": "ê²½ê¸°","ë¶€ì²œì‹œ": "ê²½ê¸°","ë¶€ì²œ": "ê²½ê¸°","ì•ˆì‚°ì‹œ": "ê²½ê¸°","ì•ˆì‚°": "ê²½ê¸°",
    "ì•ˆì–‘ì‹œ": "ê²½ê¸°","ì•ˆì–‘": "ê²½ê¸°","ë‚¨ì–‘ì£¼ì‹œ": "ê²½ê¸°","ë‚¨ì–‘ì£¼": "ê²½ê¸°","í™”ì„±ì‹œ": "ê²½ê¸°","í™”ì„±": "ê²½ê¸°","í‰íƒì‹œ": "ê²½ê¸°","í‰íƒ": "ê²½ê¸°","ì˜ì •ë¶€ì‹œ": "ê²½ê¸°","ì˜ì •ë¶€": "ê²½ê¸°","ì‹œí¥ì‹œ": "ê²½ê¸°","ì‹œí¥": "ê²½ê¸°",
    "íŒŒì£¼ì‹œ": "ê²½ê¸°","íŒŒì£¼": "ê²½ê¸°","ê¹€í¬ì‹œ": "ê²½ê¸°","ê¹€í¬": "ê²½ê¸°","ê´‘ëª…ì‹œ": "ê²½ê¸°","ê´‘ëª…": "ê²½ê¸°","êµ°í¬ì‹œ": "ê²½ê¸°","êµ°í¬": "ê²½ê¸°","ì´ì²œì‹œ": "ê²½ê¸°","ì´ì²œ": "ê²½ê¸°",
    "ì˜¤ì‚°ì‹œ": "ê²½ê¸°","ì˜¤ì‚°": "ê²½ê¸°","ì–‘ì£¼ì‹œ": "ê²½ê¸°","ì–‘ì£¼": "ê²½ê¸°","êµ¬ë¦¬ì‹œ": "ê²½ê¸°","êµ¬ë¦¬": "ê²½ê¸°","ì•ˆì„±ì‹œ": "ê²½ê¸°","ì•ˆì„±": "ê²½ê¸°","í¬ì²œì‹œ": "ê²½ê¸°","í¬ì²œ": "ê²½ê¸°","ì˜ì™•ì‹œ": "ê²½ê¸°","ì˜ì™•": "ê²½ê¸°",
    "í•˜ë‚¨ì‹œ": "ê²½ê¸°","í•˜ë‚¨": "ê²½ê¸°","ì—¬ì£¼ì‹œ": "ê²½ê¸°","ì—¬ì£¼": "ê²½ê¸°","ì–‘í‰êµ°": "ê²½ê¸°","ì–‘í‰": "ê²½ê¸°","ê°€í‰êµ°": "ê²½ê¸°","ê°€í‰": "ê²½ê¸°","ì—°ì²œêµ°": "ê²½ê¸°","ì—°ì²œ": "ê²½ê¸°",

    # ê°•ì›ë„
    "ì¶˜ì²œì‹œ": "ê°•ì›","ì¶˜ì²œ": "ê°•ì›","ì›ì£¼ì‹œ": "ê°•ì›","ì›ì£¼": "ê°•ì›","ê°•ë¦‰ì‹œ": "ê°•ì›","ê°•ë¦‰": "ê°•ì›","ë™í•´ì‹œ": "ê°•ì›","ë™í•´": "ê°•ì›","íƒœë°±ì‹œ": "ê°•ì›","íƒœë°±": "ê°•ì›","ì†ì´ˆì‹œ": "ê°•ì›","ì†ì´ˆ": "ê°•ì›",
    "ì‚¼ì²™ì‹œ": "ê°•ì›","ì‚¼ì²™": "ê°•ì›","í™ì²œêµ°": "ê°•ì›","í™ì²œ": "ê°•ì›","íš¡ì„±êµ°": "ê°•ì›","íš¡ì„±": "ê°•ì›","ì˜ì›”êµ°": "ê°•ì›","ì˜ì›”": "ê°•ì›","í‰ì°½êµ°": "ê°•ì›","í‰ì°½": "ê°•ì›","ì •ì„ êµ°": "ê°•ì›","ì •ì„ ": "ê°•ì›",
    "ì² ì›êµ°": "ê°•ì›","ì² ì›": "ê°•ì›","í™”ì²œêµ°": "ê°•ì›","í™”ì²œ": "ê°•ì›","ì–‘êµ¬êµ°": "ê°•ì›","ì–‘êµ¬": "ê°•ì›","ì¸ì œêµ°": "ê°•ì›","ì¸ì œ": "ê°•ì›","ê³ ì„±êµ°": "ê°•ì›","ê³ ì„±": "ê°•ì›","ì–‘ì–‘êµ°": "ê°•ì›","ì–‘ì–‘": "ê°•ì›","ì›ë•ì": "ê°•ì›", "ì›ë•": "ê°•ì›",

    # ì¶©ì²­ë¶ë„
    "ì²­ì£¼ì‹œ": "ì¶©ë¶","ì²­ì£¼": "ì¶©ë¶","ì¶©ì£¼ì‹œ": "ì¶©ë¶","ì¶©ì£¼": "ì¶©ë¶","ì œì²œì‹œ": "ì¶©ë¶","ì œì²œ": "ì¶©ë¶","ë³´ì€êµ°": "ì¶©ë¶","ë³´ì€": "ì¶©ë¶","ì˜¥ì²œêµ°": "ì¶©ë¶","ì˜¥ì²œ": "ì¶©ë¶","ì˜ë™êµ°": "ì¶©ë¶","ì˜ë™": "ì¶©ë¶",
    "ì§„ì²œêµ°": "ì¶©ë¶","ì§„ì²œ": "ì¶©ë¶","ê´´ì‚°êµ°": "ì¶©ë¶","ê´´ì‚°": "ì¶©ë¶","ìŒì„±êµ°": "ì¶©ë¶","ìŒì„±": "ì¶©ë¶","ë‹¨ì–‘êµ°": "ì¶©ë¶","ë‹¨ì–‘": "ì¶©ë¶",

    # ì¶©ì²­ë‚¨ë„
    "ì²œì•ˆì‹œ": "ì¶©ë‚¨","ì²œì•ˆ": "ì¶©ë‚¨","ê³µì£¼ì‹œ": "ì¶©ë‚¨","ê³µì£¼": "ì¶©ë‚¨","ë³´ë ¹ì‹œ": "ì¶©ë‚¨","ë³´ë ¹": "ì¶©ë‚¨","ì•„ì‚°ì‹œ": "ì¶©ë‚¨","ì•„ì‚°": "ì¶©ë‚¨","ì„œì‚°ì‹œ": "ì¶©ë‚¨","ì„œì‚°": "ì¶©ë‚¨","ë…¼ì‚°ì‹œ": "ì¶©ë‚¨","ë…¼ì‚°": "ì¶©ë‚¨",
    "ê³„ë£¡ì‹œ": "ì¶©ë‚¨","ê³„ë£¡": "ì¶©ë‚¨","ë‹¹ì§„ì‹œ": "ì¶©ë‚¨","ë‹¹ì§„": "ì¶©ë‚¨","ê¸ˆì‚°êµ°": "ì¶©ë‚¨","ê¸ˆì‚°": "ì¶©ë‚¨","ë¶€ì—¬êµ°": "ì¶©ë‚¨","ë¶€ì—¬": "ì¶©ë‚¨","ì„œì²œêµ°": "ì¶©ë‚¨","ì„œì²œ": "ì¶©ë‚¨","ì²­ì–‘êµ°": "ì¶©ë‚¨","ì²­ì–‘": "ì¶©ë‚¨",
    "í™ì„±êµ°": "ì¶©ë‚¨","í™ì„±": "ì¶©ë‚¨","ì˜ˆì‚°êµ°": "ì¶©ë‚¨","ì˜ˆì‚°": "ì¶©ë‚¨","íƒœì•ˆêµ°": "ì¶©ë‚¨","íƒœì•ˆ": "ì¶©ë‚¨",

    # ì „ë¼ë¶ë„
    "ì „ì£¼ì‹œ": "ì „ë¶","ì „ì£¼": "ì „ë¶","êµ°ì‚°ì‹œ": "ì „ë¶","êµ°ì‚°": "ì „ë¶","ìµì‚°ì‹œ": "ì „ë¶","ìµì‚°": "ì „ë¶","ì •ìì‹œ": "ì „ë¶","ì •ì": "ì „ë¶","ë‚¨ì›ì‹œ": "ì „ë¶","ë‚¨ì›": "ì „ë¶","ê¹€ì œì‹œ": "ì „ë¶","ê¹€ì œ": "ì „ë¶",
    "ì™„ì£¼êµ°": "ì „ë¶","ì™„ì£¼": "ì „ë¶","ì§„ì•ˆêµ°": "ì „ë¶","ì§„ì•ˆ": "ì „ë¶","ë¬´ì£¼êµ°": "ì „ë¶","ë¬´ì£¼": "ì „ë¶","ì¥ìˆ˜êµ°": "ì „ë¶","ì¥ìˆ˜": "ì „ë¶","ì„ì‹¤êµ°": "ì „ë¶","ì„ì‹¤": "ì „ë¶","ìˆœì°½êµ°": "ì „ë¶","ìˆœì°½": "ì „ë¶",
    "ê³ ì°½êµ°": "ì „ë¶","ê³ ì°½": "ì „ë¶","ë¶€ì•ˆêµ°": "ì „ë¶","ë¶€ì•ˆ": "ì „ë¶",

    # ì „ë¼ë‚¨ë„
    "ëª©í¬ì‹œ": "ì „ë‚¨","ëª©í¬": "ì „ë‚¨","ì—¬ìˆ˜ì‹œ": "ì „ë‚¨","ì—¬ìˆ˜": "ì „ë‚¨","ìˆœì²œì‹œ": "ì „ë‚¨","ìˆœì²œ": "ì „ë‚¨","ë‚˜ì£¼ì‹œ": "ì „ë‚¨","ë‚˜ì£¼": "ì „ë‚¨","ê´‘ì–‘ì‹œ": "ì „ë‚¨","ê´‘ì–‘": "ì „ë‚¨","ë‹´ì–‘êµ°": "ì „ë‚¨","ë‹´ì–‘": "ì „ë‚¨",
    "ê³¡ì„±êµ°": "ì „ë‚¨","ê³¡ì„±": "ì „ë‚¨","êµ¬ë¡€êµ°": "ì „ë‚¨","êµ¬ë¡€": "ì „ë‚¨","ê³ í¥êµ°": "ì „ë‚¨","ê³ í¥": "ì „ë‚¨","ë³´ì„±êµ°": "ì „ë‚¨","ë³´ì„±": "ì „ë‚¨","í™”ìˆœêµ°": "ì „ë‚¨","í™”ìˆœ": "ì „ë‚¨","ì¥í¥êµ°": "ì „ë‚¨","ì¥í¥": "ì „ë‚¨",
    "ê°•ì§„êµ°": "ì „ë‚¨","ê°•ì§„": "ì „ë‚¨","í•´ë‚¨êµ°": "ì „ë‚¨","í•´ë‚¨": "ì „ë‚¨","ì˜ì•”êµ°": "ì „ë‚¨","ì˜ì•”": "ì „ë‚¨","ë¬´ì•ˆêµ°": "ì „ë‚¨","ë¬´ì•ˆ": "ì „ë‚¨","í•¨í‰êµ°": "ì „ë‚¨","í•¨í‰": "ì „ë‚¨","ì˜ê´‘êµ°": "ì „ë‚¨","ì˜ê´‘": "ì „ë‚¨",
    "ì¥ì„±êµ°": "ì „ë‚¨","ì¥ì„±": "ì „ë‚¨","ì™„ë„êµ°": "ì „ë‚¨","ì™„ë„": "ì „ë‚¨","ì§„ë„êµ°": "ì „ë‚¨","ì§„ë„": "ì „ë‚¨","ì‹ ì•ˆêµ°": "ì „ë‚¨","ì‹ ì•ˆ": "ì „ë‚¨",

    # ê²½ìƒë¶ë„
    "í¬í•­ì‹œ": "ê²½ë¶","í¬í•­": "ê²½ë¶","ê²½ì£¼ì‹œ": "ê²½ë¶","ê²½ì£¼": "ê²½ë¶","ê¹€ì²œì‹œ": "ê²½ë¶","ê¹€ì²œ": "ê²½ë¶","ì•ˆë™ì‹œ": "ê²½ë¶","ì•ˆë™": "ê²½ë¶","êµ¬ë¯¸ì‹œ": "ê²½ë¶","êµ¬ë¯¸": "ê²½ë¶","ì˜ì£¼ì‹œ": "ê²½ë¶","ì˜ì£¼": "ê²½ë¶",
    "ì˜ì²œì‹œ": "ê²½ë¶","ì˜ì²œ": "ê²½ë¶","ìƒì£¼ì‹œ": "ê²½ë¶","ìƒì£¼": "ê²½ë¶","ë¬¸ê²½ì‹œ": "ê²½ë¶","ë¬¸ê²½": "ê²½ë¶","ê²½ì‚°ì‹œ": "ê²½ë¶","ê²½ì‚°": "ê²½ë¶","êµ°ìœ„êµ°": "ê²½ë¶","êµ°ìœ„": "ê²½ë¶","ì˜ì„±êµ°": "ê²½ë¶","ì˜ì„±": "ê²½ë¶",
    "ì²­ì†¡êµ°": "ê²½ë¶","ì²­ì†¡": "ê²½ë¶","ì˜ì–‘êµ°": "ê²½ë¶","ì˜ì–‘": "ê²½ë¶","ì˜ë•êµ°": "ê²½ë¶","ì˜ë•": "ê²½ë¶","ì²­ë„êµ°": "ê²½ë¶","ì²­ë„": "ê²½ë¶","ê³ ë ¹êµ°": "ê²½ë¶","ê³ ë ¹": "ê²½ë¶","ì„±ì£¼êµ°": "ê²½ë¶","ì„±ì£¼": "ê²½ë¶",
    "ì¹ ê³¡êµ°": "ê²½ë¶","ì¹ ê³¡": "ê²½ë¶","ì˜ˆì²œêµ°": "ê²½ë¶","ì˜ˆì²œ": "ê²½ë¶","ë´‰í™”êµ°": "ê²½ë¶","ë´‰í™”": "ê²½ë¶","ìš¸ì§„êµ°": "ê²½ë¶","ìš¸ì§„": "ê²½ë¶","ìš¸ë¦‰êµ°": "ê²½ë¶","ìš¸ë¦‰": "ê²½ë¶",

    # ê²½ìƒë‚¨ë„
    "ì°½ì›ì‹œ": "ê²½ë‚¨","ì°½ì›": "ê²½ë‚¨","ì§„ì£¼ì‹œ": "ê²½ë‚¨","ì§„ì£¼": "ê²½ë‚¨","í†µì˜ì‹œ": "ê²½ë‚¨","í†µì˜": "ê²½ë‚¨","ì‚¬ì²œì‹œ": "ê²½ë‚¨","ì‚¬ì²œ": "ê²½ë‚¨","ê¹€í•´ì‹œ": "ê²½ë‚¨","ê¹€í•´": "ê²½ë‚¨","ë°€ì–‘ì‹œ": "ê²½ë‚¨","ë°€ì–‘": "ê²½ë‚¨",
    "ê±°ì œì‹œ": "ê²½ë‚¨","ê±°ì œ": "ê²½ë‚¨","ì–‘ì‚°ì‹œ": "ê²½ë‚¨","ì–‘ì‚°": "ê²½ë‚¨","ì˜ë ¹êµ°": "ê²½ë‚¨","ì˜ë ¹": "ê²½ë‚¨","í•¨ì•ˆêµ°": "ê²½ë‚¨","í•¨ì•ˆ": "ê²½ë‚¨","ì°½ë…•êµ°": "ê²½ë‚¨","ì°½ë…•": "ê²½ë‚¨","ê³ ì„±êµ°": "ê²½ë‚¨","ê³ ì„±": "ê²½ë‚¨",
    "ë‚¨í•´êµ°": "ê²½ë‚¨","ë‚¨í•´": "ê²½ë‚¨","í•˜ë™êµ°": "ê²½ë‚¨","í•˜ë™": "ê²½ë‚¨","ì‚°ì²­êµ°": "ê²½ë‚¨","ì‚°ì²­": "ê²½ë‚¨","í•¨ì–‘êµ°": "ê²½ë‚¨","í•¨ì–‘": "ê²½ë‚¨","ê±°ì°½êµ°": "ê²½ë‚¨","ê±°ì°½": "ê²½ë‚¨","í•©ì²œêµ°": "ê²½ë‚¨","í•©ì²œ": "ê²½ë‚¨",

    # ì œì£¼
    "ì œì£¼ì‹œ": "ì œì£¼","ì œì£¼": "ì œì£¼","ì„œê·€í¬ì‹œ": "ì œì£¼","ì„œê·€í¬": "ì œì£¼",

    # ì„œìš¸
    "ê°•ë‚¨êµ¬": "ì„œìš¸","ê°•ë‚¨": "ì„œìš¸", "ê°•ë™êµ¬": "ì„œìš¸","ê°•ë™": "ì„œìš¸", "ê°•ë¶êµ¬": "ì„œìš¸","ê°•ë¶": "ì„œìš¸", "ê°•ì„œêµ¬": "ì„œìš¸","ê°•ì„œ": "ì„œìš¸",
    "ê´€ì•…êµ¬": "ì„œìš¸","ê´€ì•…": "ì„œìš¸", "ê´‘ì§„êµ¬": "ì„œìš¸","ê´‘ì§„": "ì„œìš¸", "êµ¬ë¡œêµ¬": "ì„œìš¸","êµ¬ë¡œ": "ì„œìš¸", "ê¸ˆì²œêµ¬": "ì„œìš¸","ê¸ˆì²œ": "ì„œìš¸",
    "ë…¸ì›êµ¬": "ì„œìš¸","ë…¸ì›": "ì„œìš¸", "ë„ë´‰êµ¬": "ì„œìš¸","ë„ë´‰": "ì„œìš¸", "ë™ëŒ€ë¬¸êµ¬": "ì„œìš¸","ë™ëŒ€ë¬¸": "ì„œìš¸", "ë™ì‘êµ¬": "ì„œìš¸","ë™ì‘": "ì„œìš¸",
    "ë§ˆí¬êµ¬": "ì„œìš¸","ë§ˆí¬": "ì„œìš¸", "ì„œëŒ€ë¬¸êµ¬": "ì„œìš¸","ì„œëŒ€ë¬¸": "ì„œìš¸", "ì„œì´ˆêµ¬": "ì„œìš¸","ì„œì´ˆ": "ì„œìš¸", "ì„±ë™êµ¬": "ì„œìš¸","ì„±ë™": "ì„œìš¸",
    "ì„±ë¶êµ¬": "ì„œìš¸","ì„±ë¶": "ì„œìš¸", "ì†¡íŒŒêµ¬": "ì„œìš¸","ì†¡íŒŒ": "ì„œìš¸", "ì–‘ì²œêµ¬": "ì„œìš¸","ì–‘ì²œ": "ì„œìš¸", "ì˜ë“±í¬êµ¬": "ì„œìš¸","ì˜ë“±í¬": "ì„œìš¸",
    "ìš©ì‚°êµ¬": "ì„œìš¸","ìš©ì‚°": "ì„œìš¸", "ì€í‰êµ¬": "ì„œìš¸","ì€í‰": "ì„œìš¸", "ì¤‘ë‘êµ¬": "ì„œìš¸","ì¤‘ë‘": "ì„œìš¸", "ì¢…ë¡œêµ¬": "ì„œìš¸", "ì¢…ë¡œ": "ì„œìš¸",

    # ê´‘ì—­ì‹œ í•˜ìœ„ êµ¬Â·êµ°
    "ë‹¬ì„±êµ°": "ëŒ€êµ¬", "ë‹¬ì„±": "ëŒ€êµ¬","ë‹¬ì„œêµ¬": "ëŒ€êµ¬", "ë‹¬ì„œ": "ëŒ€êµ¬","ìˆ˜ì„±êµ¬": "ëŒ€êµ¬", "ìˆ˜ì„±": "ëŒ€êµ¬",
    "í•´ìš´ëŒ€êµ¬": "ë¶€ì‚°", "í•´ìš´ëŒ€": "ë¶€ì‚°","ê¸ˆì •êµ¬": "ë¶€ì‚°","ê¸ˆì •": "ë¶€ì‚°", "ê¸°ì¥êµ°": "ë¶€ì‚°","ê¸°ì¥": "ë¶€ì‚°","ë™ë˜êµ¬": "ë¶€ì‚°","ë™ë˜": "ë¶€ì‚°","ë¶€ì‚°ì§„êµ¬": "ë¶€ì‚°","ì‚¬ìƒêµ¬": "ë¶€ì‚°","ì‚¬ìƒ": "ë¶€ì‚°","ì‚¬í•˜êµ¬": "ë¶€ì‚°","ì‚¬í•˜": "ë¶€ì‚°", 
    "ìˆ˜ì˜êµ¬": "ë¶€ì‚°","ìˆ˜ì˜": "ë¶€ì‚°","ì—°ì œêµ¬": "ë¶€ì‚°","ì—°ì œ": "ë¶€ì‚°","ì˜ë„êµ¬": "ë¶€ì‚°","ì˜ë„": "ë¶€ì‚°",
    "ê´‘ì‚°êµ¬": "ê´‘ì£¼","ê´‘ì‚°": "ê´‘ì£¼","ëŒ€ë•êµ¬": "ëŒ€ì „","ëŒ€ë•": "ëŒ€ì „","ìœ ì„±êµ¬": "ëŒ€ì „","ìœ ì„±": "ëŒ€ì „", "ìš¸ì£¼êµ°": "ìš¸ì‚°","ìš¸ì£¼": "ìš¸ì‚°",
    "ë¯¸ì¶”í™€êµ¬": "ì¸ì²œ", "ë¯¸ì¶”í™€": "ì¸ì²œ", "ì—°ìˆ˜êµ¬": "ì¸ì²œ", "ì—°ìˆ˜": "ì¸ì²œ", "ë¶€í‰êµ¬": "ì¸ì²œ", "ë¶€í‰": "ì¸ì²œ", "ê³„ì–‘êµ¬": "ì¸ì²œ", "ê³„ì–‘": "ì¸ì²œ", "ê°•í™”êµ°": "ì¸ì²œ", "ê°•í™”": "ì¸ì²œ", "ì˜¹ì§„êµ°": "ì¸ì²œ", "ì˜¹ì§„": "ì¸ì²œ", "ë‚¨ë™êµ¬": "ì¸ì²œ", "ë‚¨ë™": "ì¸ì²œ",

    # ëª¨í˜¸ â†’ ì „êµ­ ì²˜ë¦¬ í•„ìš”
    "ì¤‘êµ¬": "ì „êµ­","ë‚¨êµ¬": "ì „êµ­","ë™êµ¬": "ì „êµ­","ì„œêµ¬": "ì „êµ­","ë¶êµ¬": "ì „êµ­"
}

AMBIGUOUS_NAMES = {"ì¤‘êµ¬", "ë‚¨êµ¬", "ë™êµ¬", "ì„œêµ¬", "ë¶êµ¬"}

# ---------------- topicMap (ì•±ê³¼ ë™ì¼í•˜ê²Œ) ----------------
TOPIC_MAP = {
    'ì§€ì—­ ì „ì²´ í˜œíƒ': 'all',
    'ì„œìš¸': 'seoul',
    'ë¶€ì‚°': 'busan',
    'ëŒ€êµ¬': 'daegu',
    'ì¸ì²œ': 'incheon',
    'ê´‘ì£¼': 'gwangju',
    'ëŒ€ì „': 'daejeon',
    'ìš¸ì‚°': 'ulsan',
    'ì„¸ì¢…': 'sejong',
    'ê²½ê¸°': 'gyeonggi',
    'ê°•ì›': 'gangwon',
    'ì¶©ë¶': 'chungbuk',
    'ì¶©ë‚¨': 'chungnam',
    'ì „ë¶': 'jeonbuk',
    'ì „ë‚¨': 'jeonnam',
    'ê²½ë¶': 'gyeongbuk',
    'ê²½ë‚¨': 'gyeongnam',
    'ì œì£¼': 'jeju',
}

def get_topic_name(region_sido):
    if region_sido == "ì „êµ­":
        return "nation"
    code = TOPIC_MAP.get(region_sido, "all")
    return f"region_{code}"

# ---------------- extract_region ----------------
def extract_region(agency_name: str, phone: str = ""):
    if not agency_name:
        return "ì „êµ­", "ì „êµ­"

    # 1) ê´‘ì£¼ íŠ¹ë³„ ì²˜ë¦¬ (ì „í™”ë²ˆí˜¸ ê¸°ë°˜)
    if "ê´‘ì£¼" in agency_name:
        if phone and phone.startswith("031"):
            return "ê²½ê¸°", "ê´‘ì£¼ì‹œ"   # ê²½ê¸°ë„ ê´‘ì£¼
        elif phone and phone.startswith("062"):
            return "ê´‘ì£¼", "ê´‘ì£¼ê´‘ì—­ì‹œ"  # ê´‘ì£¼ê´‘ì—­ì‹œ
        # ì „í™”ë²ˆí˜¸ ì—†ìœ¼ë©´ ê´‘ì£¼ê´‘ì—­ì‹œ ê¸°ë³¸ ì²˜ë¦¬
        return "ê´‘ì£¼", "ê´‘ì£¼ê´‘ì—­ì‹œ"

    # 2) ì‹œ/ë„ëª… ì§ì ‘ í¬í•¨
    for keyword, sido in REGION_KEYWORDS.items():
        if keyword in agency_name:
            return sido, keyword if keyword not in AMBIGUOUS_NAMES else "ì „êµ­"

    # 3) â—‹â—‹ì‹œ/êµ°/êµ¬ ì¶”ì¶œ
    match = re.search(r"([ê°€-í£]{2,}(ì‹œ|êµ°|êµ¬))", agency_name)
    if match:
        sigungu = match.group(1)
        if sigungu in AMBIGUOUS_NAMES:
            return "ì „êµ­", sigungu
        return REGION_KEYWORDS.get(sigungu, "ì „êµ­"), sigungu

    # 4) ê¸°ê´€ëª… ì „ì²´ì—ì„œ ë‘ ê¸€ì ì´ìƒ í‚¤ì›Œë“œ íƒìƒ‰
    for keyword, sido in REGION_KEYWORDS.items():
        if len(keyword) >= 2 and keyword in agency_name:
            if keyword in AMBIGUOUS_NAMES:
                return "ì „êµ­", "ì „êµ­"
            return sido, keyword

    # 5) ê¸°ë³¸ê°’
    return "ì „êµ­", "ì „êµ­"

# ---------------- detect_region_from_target ----------------
def detect_region_from_target(target_text: str):
    if not target_text:
        return None
    for keyword, sido in REGION_KEYWORDS.items():
        if keyword in target_text:
            return sido
    return None

# ---------------- extract_region_with_target ----------------
def extract_region_with_target(agency_name: str, target_text: str, phone: str = ""):
    region_sido, region_sigungu = extract_region(agency_name, phone)
    if region_sido == "ì „êµ­" or not region_sido:
        target_region = detect_region_from_target(target_text)
        if target_region:
            region_sido = target_region
    return region_sido, region_sigungu

# ---------------- merge_and_save ----------------
def merge_and_save():
    print("âœ… ì„œë¹„ìŠ¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
    service_list = fetch_all_data("serviceList")
    print(f"ğŸ‘‰ ì´ {len(service_list)}ê±´ ë¶ˆëŸ¬ì˜´")

    print("âœ… ìƒì„¸ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...")
    detail_list = fetch_all_data("serviceDetail")

    print("âœ… ë³‘í•© ì¤‘...")
    detail_map = {d["ì„œë¹„ìŠ¤ID"]: d for d in detail_list if "ì„œë¹„ìŠ¤ID" in d}
    condition_map = {}

    merged = []
    for s in tqdm(service_list):
        sid = s.get("ì„œë¹„ìŠ¤ID", "")
        detail = detail_map.get(sid, {})
        condition = condition_map.get(sid, {})

        region_sido, region_sigungu = extract_region_with_target(
            s.get("ì†Œê´€ê¸°ê´€ëª…", ""),
            s.get("ì§€ì›ëŒ€ìƒ", ""),
            s.get("ì „í™”ë¬¸ì˜", "")
        )

        record = {
            "id": sid,
            "name": s.get("ì„œë¹„ìŠ¤ëª…", ""),
            "purpose": s.get("ì„œë¹„ìŠ¤ëª©ì ìš”ì•½", ""),
            "target": s.get("ì§€ì›ëŒ€ìƒ", ""),
            "criteria": s.get("ì„ ì •ê¸°ì¤€", ""),
            "details": s.get("ì§€ì›ë‚´ìš©", ""),
            "applyMethod": s.get("ì‹ ì²­ë°©ë²•", ""),
            "deadline": s.get("ì‹ ì²­ê¸°í•œ", ""),
            "viewCount": s.get("ì¡°íšŒìˆ˜", 0),
            "agency": s.get("ì†Œê´€ê¸°ê´€ëª…", ""),
            "department": s.get("ë¶€ì„œëª…", ""),
            "userType": s.get("ì‚¬ìš©ìêµ¬ë¶„", ""),
            "serviceField": s.get("ì„œë¹„ìŠ¤ë¶„ì•¼", ""),
            "applyUrl": s.get("ìƒì„¸ì¡°íšŒURL", ""),
            "phone": s.get("ì „í™”ë¬¸ì˜", ""),
            "registerDate": s.get("ë“±ë¡ì¼ì‹œ", ""),
            "updateDate": s.get("ìˆ˜ì •ì¼ì‹œ", ""),
            "fullPurpose": detail.get("ì„œë¹„ìŠ¤ëª©ì ", ""),
            "requiredDocs": detail.get("êµ¬ë¹„ì„œë¥˜", ""),
            "receptionOrg": detail.get("ì ‘ìˆ˜ê¸°ê´€ëª…", ""),
            "onlineUrl": detail.get("ì˜¨ë¼ì¸ì‹ ì²­ì‚¬ì´íŠ¸URL", ""),
            "law": detail.get("ë²•ë ¹", ""),
            "condition": condition,
            "regionSido": region_sido,
            "regionSigungu": region_sigungu
        }
        merged.append(record)

    with gzip.open(OUTPUT_PATH, "wt", encoding="utf-8") as f:
        json.dump(merged, f, ensure_ascii=False)

    print(f"ğŸ‰ ì´ {len(merged)}ê±´ ì €ì¥ ì™„ë£Œ â†’ {OUTPUT_PATH} (gzip ì••ì¶•)")
    return merged

def load_existing_ids():
    """ê¸°ì¡´ benefits.json.gzì—ì„œ id ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°"""
    if not os.path.exists(OUTPUT_PATH):
        return set()
    with gzip.open(OUTPUT_PATH, "rt", encoding="utf-8") as f:
        data = json.load(f)
    return {b["id"] for b in data}
# ---------------- Firebase Access Token ----------------
def get_access_token():
    credentials = service_account.Credentials.from_service_account_file(
        SERVICE_ACCOUNT_FILE,
        scopes=["https://www.googleapis.com/auth/firebase.messaging"],
    )
    request = google.auth.transport.requests.Request()
    credentials.refresh(request)
    return credentials.token

# ---------------- Firebase HTTP ì•Œë¦¼ ----------------
def send_fcm_http_v1(topic, title, body):
    access_token = get_access_token()
    url = f"https://fcm.googleapis.com/v1/projects/{PROJECT_ID}/messages:send"
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json; UTF-8",
    }
    payload = {
        "message": {
            "topic": topic,
            "notification": {
                "title": title,
                "body": body
            }
        }
    }
    response = requests.post(url, headers=headers, json=payload)
    print(f"FCM HTTP ì‘ë‹µ({topic}): {response.status_code} {response.text}")

# ---------------- ì‹ ê·œ í˜œíƒ ì²˜ë¦¬ ----------------
def is_same_day(date_str):
    """YYYYMMDD[HHMMSS] í˜•ì‹ ì• 8ìë¦¬ë¡œ ì˜¤ëŠ˜ ì—¬ë¶€ íŒë‹¨"""
    if not date_str:
        return False
    try:
        return str(date_str)[:8] == datetime.now().strftime("%Y%m%d")
    except Exception as e:
        print(f"ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨: {date_str}, {e}")
        return False

def notify_new_benefits(benefits):
    # 1) ì§€ì—­ë³„(ì „êµ­ ì œì™¸) ì‹œÂ·ë„ ì§‘í•©
    region_sidos = sorted({
        b.get("regionSido")
        for b in benefits
        if b.get("regionSido") and b.get("regionSido") != "ì „êµ­"
    })

    # 2) ì§€ì—­ë³„ ê° 1íšŒ (ì œëª©ì— ì‹œÂ·ë„ëª… í‘œì‹œ)
    for sido in region_sidos:
        topic = get_topic_name(sido)  # ex) region_busan
        send_fcm_http_v1(topic, f"{sido} ì‹ ê·œ í˜œíƒì´ ë“±ë¡ëì–´ìš”!", "ì§€ê¸ˆ í™•ì¸í•´ë³´ì„¸ìš”.")

    # 3) ì§€ì—­ ì‹ ê·œê°€ 1ê°œë¼ë„ ìˆìœ¼ë©´ region_all 1íšŒ (ë¼ë²¨ ëª…í™•í™”)
    if region_sidos:
        send_fcm_http_v1("region_all", "ì „ì²´ ì§€ì—­ ì‹ ê·œ í˜œíƒì´ ë“±ë¡ëì–´ìš”!", "ì§€ê¸ˆ í™•ì¸í•´ë³´ì„¸ìš”.")

    # 4) ì „êµ­ ìš´ì˜ í˜œíƒì´ ìˆìœ¼ë©´ nation 1íšŒ (ë¼ë²¨ ëª…í™•í™”)
    if any(b.get("regionSido") == "ì „êµ­" for b in benefits):
        send_fcm_http_v1("nation", "ì „êµ­ ìš´ì˜ í˜œíƒì´ ë“±ë¡ëì–´ìš”!", "ì§€ê¸ˆ í™•ì¸í•´ë³´ì„¸ìš”.")

# ---------------- main ----------------
if __name__ == "__main__":
    existing_ids = load_existing_ids()   # ì´ì „ íŒŒì¼ì˜ IDë“¤
    is_bootstrap = (len(existing_ids) == 0)   # âœ… ì¶”ê°€: ì´ˆê¸° ì‹¤í–‰ ì—¬ë¶€ í‘œì‹œ

    new_data = merge_and_save()          # ìƒˆë¡œ í¬ë¡¤ë§/ë³‘í•©ëœ ì „ì²´ ë°ì´í„°

    # 1) íŒŒì¼ ê¸°ì¤€ 'ì²˜ìŒ ë°œê²¬ëœ' ì‹ ê·œ (ë“±ë¡ì¼ê³¼ ë¬´ê´€)
    newly_discovered = [b for b in new_data if b["id"] not in existing_ids]

    # âœ… ì¶”ê°€: ì´ˆê¸° ì‹¤í–‰ì´ë©´ 'ì²˜ìŒ ë°œê²¬' ì œì™¸í•´ ëŒ€ëŸ‰ ê±´ìˆ˜ ë°©ì§€
    if is_bootstrap:
        print("ì´ˆê¸° ì‹¤í–‰ ê°ì§€ â†’ ì˜¤ëŠ˜ ë“±ë¡ë¶„ë§Œ ì•Œë¦¼(ì²˜ìŒë°œê²¬ ì œì™¸)")
        newly_discovered = []

    # 2) ì˜¤ëŠ˜ 'ë“±ë¡'ëœ í•­ëª© (ì´ë¯¸ ìˆë˜ ê²ƒë„ í¬í•¨)
    today_registered = [b for b in new_data if is_same_day(b.get("registerDate", ""))]

    # 3) ì•Œë¦¼ í›„ë³´: (ì²˜ìŒ ë°œê²¬) âˆª (ì˜¤ëŠ˜ ë“±ë¡)
    candidates_by_id = {}
    for b in newly_discovered + today_registered:
        candidates_by_id[b["id"]] = b
    candidates = list(candidates_by_id.values())

    # ë””ë²„ê·¸ ë¡œê·¸
    print(
        f"ì²˜ìŒë°œê²¬:{len(newly_discovered)} / ì˜¤ëŠ˜ë“±ë¡:{len(today_registered)} "
        f"â†’ ì•Œë¦¼ëŒ€ìƒ í•©ê³„:{len(candidates)}"
    )
    if newly_discovered[:5]:
        print("ìƒ˜í”Œ ì²˜ìŒë°œê²¬ ID:", [b["id"] for b in newly_discovered[:5]])

    if candidates:
        print(f"ì•Œë¦¼ ëŒ€ìƒ {len(candidates)}ê±´ â†’ FCM ì „ì†¡")
        notify_new_benefits(candidates)
    else:
        print("ì‹ ê·œ/ê°±ì‹  ì—†ìŒ â†’ ì•Œë¦¼ ìƒëµ")